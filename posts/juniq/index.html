<!DOCTYPE html>
<html lang="ja-jp">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>バーチャル美少女定理証明士を支える技術 - The curse of λ</title>
<meta name="author" content="myuon">
<meta name="description" content="λに捧げよ">

<meta name="generator" content="Hugo 0.52" />


<link href="//fonts.googleapis.com/css?family=Roboto:400" rel="stylesheet">
<link rel="stylesheet" href='/assets/css/main.39ec5efb65b7.css'>


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon.png">
<link rel="shortcut icon" href="/assets/img/favicon.ico">


<link href="/posts/index.xml" rel="alternate" type="application/rss+xml" title="The curse of λ" />
<link href="/posts/index.xml" rel="feed" type="application/rss+xml" title="The curse of λ" />

<meta property="og:title" content="バーチャル美少女定理証明士を支える技術" />
<meta property="og:description" content="この記事とは特に関係ないのですがVTuber Techアドベントカレンダー(その1 その2)があるらしいので興味がある人は覗いてみるといいんじゃないでしょうか。
バーチャル引きこもり病弱定理証明士 夕暮寝子というのがいて、その子の裏側のシステムを作ったので(作ったのはだいぶ前)その解説をします。なお問題は山積みの模様(そもそも私以外の人が使う想定じゃないので自分でいじるなりなんなりしてください)。
技術スタック: Docker, Python, TypeScript, dlib (Python bindings), OpenCVちょこっと, Live2D SDK
💞はじめまして💞
🎊夕暮寝子といいます🎊
😴電脳空間で引きこもりをやっています😴
💻プログラムとか証明とかを書きます💻
💪Live2D動かすやつ作ってるのでそれができたらデビューします💪
👏よろしくお願いします👏#Vtuber準備中#Vtuber始めました#新人Vtuber#Vtuber pic.twitter.com/UAM9iTrFLU
&mdash; 夕暮寝子 (@YugureNeko) 2018年7月24日 
リポジトリ コードは全部公開しています。
https://github.com/myuon/juniQ
免責事項
このプログラム群はMITライセンスで公開しています(リポジトリにsubmoduleとして含まれるcubism-jsには当たり前ですがこのライセンスは適用されません)。
このソフトウェアはLive2D SDK for webを利用しており、ソースコードの公開及びブログにおけるコードの解説はLive2Dから許可を得て行っています。
このソフトウェアを利用して作られたものを出版(コードの一部または全部を公開することも含まれるようです)する場合にはLive2Dとの契約が必要になる場合があるのでその辺はちゃんと問い合わせてください。
Live2D SDKリリースライセンス: https://www.live2d.com/ja/products/releaselicense
(これ読む限りだとソースコードの一部を公開するだけでも出版にあたるかもみたいな書き方だったけど問い合わせたらソースコードの公開だけなら契約不要って言われたので割とLive2D側に判断の裁量がありそうです。まぁなんかやりたくなったらとりあえず聞いてみるのがよさそうな感じだった。)
アーキテクチャ 次のような仕組みで動きます
 ブラウザからカメラ映像を取得、websocketサーバーに画像を30fpsで投げる サーバーが画像を受け取って顔の検出等を行いパラメータを計算する 計算されたパラメータがブラウザのviewerに再度投げ返される viewerはLive2Dモデルを描画  なんでやねん なんやねんこれと思うと思うんですがこれはホストPCがWindowsでありWindowsで開発はできないことと、VirtualBoxではUSBの映像出力等を直接受け取れない等の技術的制約により悲しくも厳しい設計になっています。
やーまじ全部Unityかなんかで作ればよかったーって後になって後悔したんですがしかしdlibとかのライブラリがUnityのアセットストアだとまともそうなやつはすごく高くていやいやみたいな気持ちになったりしたのはある。Unityネイティブプラグインで頑張って作り直したいけどつらそう。
あとクライアントからサーバーに直接映像を投げるのって意外と難しくて(browser to browserだとそれっぽい技術は意外とあるんだけど…)あんま選択肢がないし、そもそも検出とかの関係で絶対画像を切り出す必要があるのでまぁブラウザで切って送ればいいんじゃないかみたいになっておる。当然この処理は割と負荷かかるのでうんまぁみたいな感じ。
あとCORSの設定がこれを作ったときはよくわかってなかったのでFirefoxでしか多分動かないです。そのうちFirefoxでも動かなくなる可能性がある。
映像取得部分 映像と音声を取得する。getUserMediaとかを使うとできる。映像は30fpsくらいに落としてwebsocketサーバーにjpeg画像として投げつける。音声はリップシンクのために使う。
リップシンク作るところだけ載せます。
// https://github.com/myuon/juniQ/blob/master/viewer/src/index.ts#L42 class AudioVolume { processor: ScriptProcessorNode; volume: number; clipLevel: number; averaging: number; clipping: boolean; lastClip: number; clipLag: number; constructor(audioContext: AudioContext, clipLevel = 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://myuon.github.io/posts/juniq/" /><meta property="article:published_time" content="2018-12-25T20:25:54&#43;09:00"/>
<meta property="article:modified_time" content="2018-12-25T20:25:54&#43;09:00"/>



<meta itemprop="name" content="バーチャル美少女定理証明士を支える技術">
<meta itemprop="description" content="この記事とは特に関係ないのですがVTuber Techアドベントカレンダー(その1 その2)があるらしいので興味がある人は覗いてみるといいんじゃないでしょうか。
バーチャル引きこもり病弱定理証明士 夕暮寝子というのがいて、その子の裏側のシステムを作ったので(作ったのはだいぶ前)その解説をします。なお問題は山積みの模様(そもそも私以外の人が使う想定じゃないので自分でいじるなりなんなりしてください)。
技術スタック: Docker, Python, TypeScript, dlib (Python bindings), OpenCVちょこっと, Live2D SDK
💞はじめまして💞
🎊夕暮寝子といいます🎊
😴電脳空間で引きこもりをやっています😴
💻プログラムとか証明とかを書きます💻
💪Live2D動かすやつ作ってるのでそれができたらデビューします💪
👏よろしくお願いします👏#Vtuber準備中#Vtuber始めました#新人Vtuber#Vtuber pic.twitter.com/UAM9iTrFLU
&mdash; 夕暮寝子 (@YugureNeko) 2018年7月24日 
リポジトリ コードは全部公開しています。
https://github.com/myuon/juniQ
免責事項
このプログラム群はMITライセンスで公開しています(リポジトリにsubmoduleとして含まれるcubism-jsには当たり前ですがこのライセンスは適用されません)。
このソフトウェアはLive2D SDK for webを利用しており、ソースコードの公開及びブログにおけるコードの解説はLive2Dから許可を得て行っています。
このソフトウェアを利用して作られたものを出版(コードの一部または全部を公開することも含まれるようです)する場合にはLive2Dとの契約が必要になる場合があるのでその辺はちゃんと問い合わせてください。
Live2D SDKリリースライセンス: https://www.live2d.com/ja/products/releaselicense
(これ読む限りだとソースコードの一部を公開するだけでも出版にあたるかもみたいな書き方だったけど問い合わせたらソースコードの公開だけなら契約不要って言われたので割とLive2D側に判断の裁量がありそうです。まぁなんかやりたくなったらとりあえず聞いてみるのがよさそうな感じだった。)
アーキテクチャ 次のような仕組みで動きます
 ブラウザからカメラ映像を取得、websocketサーバーに画像を30fpsで投げる サーバーが画像を受け取って顔の検出等を行いパラメータを計算する 計算されたパラメータがブラウザのviewerに再度投げ返される viewerはLive2Dモデルを描画  なんでやねん なんやねんこれと思うと思うんですがこれはホストPCがWindowsでありWindowsで開発はできないことと、VirtualBoxではUSBの映像出力等を直接受け取れない等の技術的制約により悲しくも厳しい設計になっています。
やーまじ全部Unityかなんかで作ればよかったーって後になって後悔したんですがしかしdlibとかのライブラリがUnityのアセットストアだとまともそうなやつはすごく高くていやいやみたいな気持ちになったりしたのはある。Unityネイティブプラグインで頑張って作り直したいけどつらそう。
あとクライアントからサーバーに直接映像を投げるのって意外と難しくて(browser to browserだとそれっぽい技術は意外とあるんだけど…)あんま選択肢がないし、そもそも検出とかの関係で絶対画像を切り出す必要があるのでまぁブラウザで切って送ればいいんじゃないかみたいになっておる。当然この処理は割と負荷かかるのでうんまぁみたいな感じ。
あとCORSの設定がこれを作ったときはよくわかってなかったのでFirefoxでしか多分動かないです。そのうちFirefoxでも動かなくなる可能性がある。
映像取得部分 映像と音声を取得する。getUserMediaとかを使うとできる。映像は30fpsくらいに落としてwebsocketサーバーにjpeg画像として投げつける。音声はリップシンクのために使う。
リップシンク作るところだけ載せます。
// https://github.com/myuon/juniQ/blob/master/viewer/src/index.ts#L42 class AudioVolume { processor: ScriptProcessorNode; volume: number; clipLevel: number; averaging: number; clipping: boolean; lastClip: number; clipLag: number; constructor(audioContext: AudioContext, clipLevel = 0.">


<meta itemprop="datePublished" content="2018-12-25T20:25:54&#43;09:00" />
<meta itemprop="dateModified" content="2018-12-25T20:25:54&#43;09:00" />
<meta itemprop="wordCount" content="1150">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="バーチャル美少女定理証明士を支える技術"/>
<meta name="twitter:description" content="この記事とは特に関係ないのですがVTuber Techアドベントカレンダー(その1 その2)があるらしいので興味がある人は覗いてみるといいんじゃないでしょうか。
バーチャル引きこもり病弱定理証明士 夕暮寝子というのがいて、その子の裏側のシステムを作ったので(作ったのはだいぶ前)その解説をします。なお問題は山積みの模様(そもそも私以外の人が使う想定じゃないので自分でいじるなりなんなりしてください)。
技術スタック: Docker, Python, TypeScript, dlib (Python bindings), OpenCVちょこっと, Live2D SDK
💞はじめまして💞
🎊夕暮寝子といいます🎊
😴電脳空間で引きこもりをやっています😴
💻プログラムとか証明とかを書きます💻
💪Live2D動かすやつ作ってるのでそれができたらデビューします💪
👏よろしくお願いします👏#Vtuber準備中#Vtuber始めました#新人Vtuber#Vtuber pic.twitter.com/UAM9iTrFLU
&mdash; 夕暮寝子 (@YugureNeko) 2018年7月24日 
リポジトリ コードは全部公開しています。
https://github.com/myuon/juniQ
免責事項
このプログラム群はMITライセンスで公開しています(リポジトリにsubmoduleとして含まれるcubism-jsには当たり前ですがこのライセンスは適用されません)。
このソフトウェアはLive2D SDK for webを利用しており、ソースコードの公開及びブログにおけるコードの解説はLive2Dから許可を得て行っています。
このソフトウェアを利用して作られたものを出版(コードの一部または全部を公開することも含まれるようです)する場合にはLive2Dとの契約が必要になる場合があるのでその辺はちゃんと問い合わせてください。
Live2D SDKリリースライセンス: https://www.live2d.com/ja/products/releaselicense
(これ読む限りだとソースコードの一部を公開するだけでも出版にあたるかもみたいな書き方だったけど問い合わせたらソースコードの公開だけなら契約不要って言われたので割とLive2D側に判断の裁量がありそうです。まぁなんかやりたくなったらとりあえず聞いてみるのがよさそうな感じだった。)
アーキテクチャ 次のような仕組みで動きます
 ブラウザからカメラ映像を取得、websocketサーバーに画像を30fpsで投げる サーバーが画像を受け取って顔の検出等を行いパラメータを計算する 計算されたパラメータがブラウザのviewerに再度投げ返される viewerはLive2Dモデルを描画  なんでやねん なんやねんこれと思うと思うんですがこれはホストPCがWindowsでありWindowsで開発はできないことと、VirtualBoxではUSBの映像出力等を直接受け取れない等の技術的制約により悲しくも厳しい設計になっています。
やーまじ全部Unityかなんかで作ればよかったーって後になって後悔したんですがしかしdlibとかのライブラリがUnityのアセットストアだとまともそうなやつはすごく高くていやいやみたいな気持ちになったりしたのはある。Unityネイティブプラグインで頑張って作り直したいけどつらそう。
あとクライアントからサーバーに直接映像を投げるのって意外と難しくて(browser to browserだとそれっぽい技術は意外とあるんだけど…)あんま選択肢がないし、そもそも検出とかの関係で絶対画像を切り出す必要があるのでまぁブラウザで切って送ればいいんじゃないかみたいになっておる。当然この処理は割と負荷かかるのでうんまぁみたいな感じ。
あとCORSの設定がこれを作ったときはよくわかってなかったのでFirefoxでしか多分動かないです。そのうちFirefoxでも動かなくなる可能性がある。
映像取得部分 映像と音声を取得する。getUserMediaとかを使うとできる。映像は30fpsくらいに落としてwebsocketサーバーにjpeg画像として投げつける。音声はリップシンクのために使う。
リップシンク作るところだけ載せます。
// https://github.com/myuon/juniQ/blob/master/viewer/src/index.ts#L42 class AudioVolume { processor: ScriptProcessorNode; volume: number; clipLevel: number; averaging: number; clipping: boolean; lastClip: number; clipLag: number; constructor(audioContext: AudioContext, clipLevel = 0."/>


  </head>
  <body>
    <nav>
  <a href="/" title="">
    The curse of λ
  </a>
  
    <a class="homePageIcon" href="/" title="">
      <svg fill="#000000" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        <path d="M0 0h24v24H0z" fill="none"/>
      </svg>
    </a>
  
</nav>

    <main>
      
  <div class="progress-container">
    <div class="progress-bar"></div>
  </div>
  <article>
    <header>
      <time datetime="2018-12-25 08:25">2018-12-25</time>
      <h1>バーチャル美少女定理証明士を支える技術</h1>
    </header>
    <section>

<p>この記事とは特に関係ないのですがVTuber Techアドベントカレンダー(<a href="https://qiita.com/advent-calendar/2018/vtuber">その1</a> <a href="https://qiita.com/advent-calendar/2018/vtuber2">その2</a>)があるらしいので興味がある人は覗いてみるといいんじゃないでしょうか。</p>

<p>バーチャル引きこもり病弱定理証明士 夕暮寝子というのがいて、その子の裏側のシステムを作ったので(作ったのはだいぶ前)その解説をします。なお問題は山積みの模様(そもそも私以外の人が使う想定じゃないので自分でいじるなりなんなりしてください)。</p>

<p>技術スタック: Docker, Python, TypeScript, dlib (Python bindings), OpenCVちょこっと, Live2D SDK</p>

<p><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">💞はじめまして💞<br>🎊夕暮寝子といいます🎊<br>😴電脳空間で引きこもりをやっています😴<br>💻プログラムとか証明とかを書きます💻<br><br>💪Live2D動かすやつ作ってるのでそれができたらデビューします💪<br>👏よろしくお願いします👏<a href="https://twitter.com/hashtag/Vtuber%E6%BA%96%E5%82%99%E4%B8%AD?src=hash&amp;ref_src=twsrc%5Etfw">#Vtuber準備中</a><a href="https://twitter.com/hashtag/Vtuber%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F?src=hash&amp;ref_src=twsrc%5Etfw">#Vtuber始めました</a><a href="https://twitter.com/hashtag/%E6%96%B0%E4%BA%BAVtuber?src=hash&amp;ref_src=twsrc%5Etfw">#新人Vtuber</a><a href="https://twitter.com/hashtag/Vtuber?src=hash&amp;ref_src=twsrc%5Etfw">#Vtuber</a> <a href="https://t.co/UAM9iTrFLU">pic.twitter.com/UAM9iTrFLU</a></p>&mdash; 夕暮寝子 (@YugureNeko) <a href="https://twitter.com/YugureNeko/status/1021752401865240576?ref_src=twsrc%5Etfw">2018年7月24日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<h2 id="リポジトリ">リポジトリ</h2>

<p>コードは全部公開しています。</p>

<p><a href="https://github.com/myuon/juniQ">https://github.com/myuon/juniQ</a></p>

<p><strong>免責事項</strong></p>

<p>このプログラム群はMITライセンスで公開しています(リポジトリにsubmoduleとして含まれるcubism-jsには当たり前ですがこのライセンスは適用されません)。<br />
このソフトウェアはLive2D SDK for webを利用しており、ソースコードの公開及びブログにおけるコードの解説はLive2Dから許可を得て行っています。</p>

<p>このソフトウェアを利用して作られたものを出版(コードの一部または全部を公開することも含まれるようです)する場合にはLive2Dとの契約が必要になる場合があるのでその辺はちゃんと問い合わせてください。</p>

<p>Live2D SDKリリースライセンス: <a href="https://www.live2d.com/ja/products/releaselicense">https://www.live2d.com/ja/products/releaselicense</a></p>

<p>(<a href="https://www.live2d.com/eula/live2d-open-software-license-agreement_jp.html">これ</a>読む限りだとソースコードの一部を公開するだけでも出版にあたるかもみたいな書き方だったけど問い合わせたらソースコードの公開だけなら契約不要って言われたので割とLive2D側に判断の裁量がありそうです。まぁなんかやりたくなったらとりあえず聞いてみるのがよさそうな感じだった。)</p>

<h2 id="アーキテクチャ">アーキテクチャ</h2>

<p>次のような仕組みで動きます</p>

<ul>
<li>ブラウザからカメラ映像を取得、websocketサーバーに画像を30fpsで投げる</li>
<li>サーバーが画像を受け取って顔の検出等を行いパラメータを計算する</li>
<li>計算されたパラメータがブラウザのviewerに再度投げ返される</li>
<li>viewerはLive2Dモデルを描画</li>
</ul>

<h3 id="なんでやねん">なんでやねん</h3>

<p>なんやねんこれと思うと思うんですがこれはホストPCがWindowsでありWindowsで開発はできないことと、VirtualBoxではUSBの映像出力等を直接受け取れない等の技術的制約により悲しくも厳しい設計になっています。</p>

<p>やーまじ全部Unityかなんかで作ればよかったーって後になって後悔したんですがしかしdlibとかのライブラリがUnityのアセットストアだとまともそうなやつはすごく高くていやいやみたいな気持ちになったりしたのはある。Unityネイティブプラグインで頑張って作り直したいけどつらそう。</p>

<p>あとクライアントからサーバーに直接映像を投げるのって意外と難しくて(browser to browserだとそれっぽい技術は意外とあるんだけど…)あんま選択肢がないし、そもそも検出とかの関係で絶対画像を切り出す必要があるのでまぁブラウザで切って送ればいいんじゃないかみたいになっておる。当然この処理は割と負荷かかるのでうんまぁみたいな感じ。</p>

<p>あとCORSの設定がこれを作ったときはよくわかってなかったのでFirefoxでしか多分動かないです。そのうちFirefoxでも動かなくなる可能性がある。</p>

<h2 id="映像取得部分">映像取得部分</h2>

<p>映像と音声を取得する。<code>getUserMedia</code>とかを使うとできる。映像は30fpsくらいに落としてwebsocketサーバーにjpeg画像として投げつける。音声はリップシンクのために使う。</p>

<p>リップシンク作るところだけ載せます。</p>
<div class="highlight"><pre class="chroma"><code class="language-ts" data-lang="ts"><span class="c1">// https://github.com/myuon/juniQ/blob/master/viewer/src/index.ts#L42
</span><span class="c1"></span><span class="kr">class</span> <span class="nx">AudioVolume</span> <span class="p">{</span>
  <span class="nx">processor</span>: <span class="kt">ScriptProcessorNode</span><span class="p">;</span>
  <span class="nx">volume</span>: <span class="kt">number</span><span class="p">;</span>
  <span class="nx">clipLevel</span>: <span class="kt">number</span><span class="p">;</span>
  <span class="nx">averaging</span>: <span class="kt">number</span><span class="p">;</span>
  <span class="nx">clipping</span>: <span class="kt">boolean</span><span class="p">;</span>
  <span class="nx">lastClip</span>: <span class="kt">number</span><span class="p">;</span>
  <span class="nx">clipLag</span>: <span class="kt">number</span><span class="p">;</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="nx">audioContext</span>: <span class="kt">AudioContext</span><span class="p">,</span> <span class="nx">clipLevel</span> <span class="o">=</span> <span class="mf">0.98</span><span class="p">,</span> <span class="nx">averaging</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> <span class="nx">clipLag</span> <span class="o">=</span> <span class="mi">750</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">processor</span> <span class="o">=</span> <span class="nx">audioContext</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">volumeAudioProcess</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clipping</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lastClip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clipLevel</span> <span class="o">=</span> <span class="nx">clipLevel</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">averaging</span> <span class="o">=</span> <span class="nx">averaging</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clipLag</span> <span class="o">=</span> <span class="nx">clipLag</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">audioContext</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 音声がイベントとしてやってくるので音量を取得する
</span><span class="c1"></span>  <span class="nx">volumeAudioProcess</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">AudioProcessingEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="c1">// audio bufferから音量を合計
</span><span class="c1"></span>    <span class="nx">buf</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clipLevel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">clipping</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastClip</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="c1">// 長さで割る
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">rms</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">sum</span> <span class="err">/ buf.length);</span>

    <span class="c1">// あまり急激に大きくならないように補正
</span><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">volume</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">rms</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">volume</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">averaging</span> <span class="err">/ 2);</span>
  <span class="p">};</span>

  <span class="nx">checkClipping</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">clipping</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">lastClip</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">clipLag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clipping</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">clipping</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">shutdown</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div>
<h2 id="サーバーサイド-顔検出-計算">サーバーサイド(顔検出&amp;計算)</h2>

<p>次の処理を行う</p>

<ul>
<li>顔検出(dlib)</li>
<li>口の輪郭とか目の輪郭とかのパーツの検出(dlib)</li>
<li>パーツごとにパラメータの計算

<ul>
<li>体の左右傾き具合</li>
<li>顔の向きと回転角度</li>
<li>目の開き具合</li>
<li>目の中心位置(視線推定)</li>
<li>口の開き具合(なおオーディオリップシンク入れるのでこの機能は実質死んでる)</li>
<li>手の位置(肌色っぽい領域の中心位置を推定して手の位置を取ろうとした残骸があるけど肌色がありふれすぎてて精度があまりに悪いのでお蔵入り 多分緑色のテープとかを手にまくといい感じになると思う)</li>
</ul></li>
<li>カルマンフィルタで滑らかにする</li>
</ul>

<h4 id="顔検出">顔検出</h4>

<p>画像から顔の領域を切り出す。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 顔の領域を検出するやつ</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_frontal_face_detector</span><span class="p">()</span>

<span class="c1"># 顔の領域からパーツの輪郭を検出するやつ</span>
<span class="c1"># 機械学習ベースなので学習モデルが必要</span>
<span class="c1"># dlibが配ってるデータとかをもらってくる</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">face_landmark_path</span><span class="p">))</span>

<span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L216</span>
  <span class="k">if</span> <span class="n">should_detect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># 顔の領域をとってくる(リストで帰ってくる)</span>
    <span class="n">face_rects</span> <span class="o">=</span> <span class="n">detector</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">should_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">should_detect</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_rects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># 最初のやつ(そもそも1人しか映ることを想定してない)の領域を切ってくる</span>
    <span class="n">face_rect</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
      <span class="nb">int</span><span class="p">(</span><span class="n">face_rects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">resize</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
      <span class="nb">int</span><span class="p">(</span><span class="n">face_rects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">top</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">resize</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
      <span class="nb">int</span><span class="p">(</span><span class="n">face_rects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">resize</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
      <span class="nb">int</span><span class="p">(</span><span class="n">face_rects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">resize</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
    <span class="p">)</span></code></pre></div>
<p><code>detector(frame, 0)</code>とかで顔の領域を切り出せる。簡単。</p>

<p>このdetectorの処理はかなり重いらしく、実際に他の処理に比べて時間がかかりがちなので毎フレームやるのはつらい。私は顔の領域自体は3フレームに1回だけ検出してる。<code>predictor</code>は重くないので毎回回して大丈夫。</p>

<h4 id="パーツ検出">パーツ検出</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="n">shape</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">face_rect</span><span class="p">)</span></code></pre></div>
<p>だけでよい。簡単。</p>

<p>戻り値はパラメータが入ってくるが<a href="https://www.pyimagesearch.com/2017/04/03/facial-landmarks-dlib-opencv-python/">ここ</a>の中断くらいにある<a href="https://www.pyimagesearch.com/wp-content/uploads/2017/04/facial_landmarks_68markup.jpg">この画像</a>を参考にするとよい。</p>

<p>ちなみに以下のようになる。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L89</span>
<span class="k">def</span> <span class="nf">create_parts_list</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="c1"># 顔の輪郭</span>
    <span class="s1">&#39;chin&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="c1"># 眉</span>
    <span class="s1">&#39;left_eyebrow&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s1">&#39;right_eyebrow&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="c1"># 鼻(縦横)</span>
    <span class="s1">&#39;nose_bridge&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s1">&#39;nose_tip&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">36</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="c1"># 目</span>
    <span class="s1">&#39;right_eye&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">42</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s1">&#39;left_eye&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">48</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="c1"># 口</span>
    <span class="s1">&#39;outer_lip&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">48</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s1">&#39;inner_lip&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">68</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
  <span class="p">}</span></code></pre></div>
<h4 id="顔の方向推定">顔の方向推定</h4>

<p>顔の方向推定は割と難しいのだけど、大体次のような感じでやる。</p>

<ul>
<li>あらかじめ、顔のパーツの3D座標を調べておく(目の中心とか輪郭の中心とか)</li>
<li>顔のパーツの座標から対応する2D座標を持ってくる</li>
<li>solvePnPで解く(2Dと3Dの対応点から回転ベクトルを求めたりするやつ; OpenCVにある)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L9</span>
<span class="n">K</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.5308391993466671e+002</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.1950000000000000e+002</span><span class="p">,</span>
     <span class="mf">0.0</span><span class="p">,</span> <span class="mf">6.5308391993466671e+002</span><span class="p">,</span> <span class="mf">2.3950000000000000e+002</span><span class="p">,</span>
     <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">D</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.0834633684407095e-002</span><span class="p">,</span> <span class="mf">6.9140193737175351e-002</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3073460323689292e+000</span><span class="p">]</span>

<span class="n">cam_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">dist_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># 顔の3D座標とかそういうやつ</span>
<span class="c1"># どこかからもらってきたやつと職人による手作業でチューニングされてる</span>
<span class="n">object_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span>
  <span class="p">[</span><span class="mf">6.825897</span><span class="p">,</span> <span class="mf">6.760612</span><span class="p">,</span> <span class="mf">4.402142</span><span class="p">],</span> <span class="c1"># 17</span>
  <span class="p">[</span><span class="mf">1.330353</span><span class="p">,</span> <span class="mf">7.122144</span><span class="p">,</span> <span class="mf">6.903745</span><span class="p">],</span> <span class="c1"># 21</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">1.330353</span><span class="p">,</span> <span class="mf">7.122144</span><span class="p">,</span> <span class="mf">6.903745</span><span class="p">],</span> <span class="c1"># 22</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">6.825897</span><span class="p">,</span> <span class="mf">6.760612</span><span class="p">,</span> <span class="mf">4.402142</span><span class="p">],</span> <span class="c1"># 26</span>
  <span class="p">[</span><span class="mf">5.311432</span><span class="p">,</span> <span class="mf">5.485328</span><span class="p">,</span> <span class="mf">3.987654</span><span class="p">],</span> <span class="c1"># 36</span>
  <span class="p">[</span><span class="mf">1.789930</span><span class="p">,</span> <span class="mf">5.393625</span><span class="p">,</span> <span class="mf">4.413414</span><span class="p">],</span> <span class="c1"># 39</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">1.789930</span><span class="p">,</span> <span class="mf">5.393625</span><span class="p">,</span> <span class="mf">4.413414</span><span class="p">],</span> <span class="c1"># 42</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">5.311432</span><span class="p">,</span> <span class="mf">5.485328</span><span class="p">,</span> <span class="mf">3.987654</span><span class="p">],</span> <span class="c1"># 45</span>
  <span class="p">[</span><span class="mf">2.005628</span><span class="p">,</span> <span class="mf">1.409845</span><span class="p">,</span> <span class="mf">6.165652</span><span class="p">],</span> <span class="c1"># 31</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">2.005628</span><span class="p">,</span> <span class="mf">1.409845</span><span class="p">,</span> <span class="mf">6.165652</span><span class="p">],</span> <span class="c1"># 35</span>
  <span class="p">[</span><span class="mf">2.774015</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.080775</span><span class="p">,</span> <span class="mf">5.048531</span><span class="p">],</span> <span class="c1"># 48</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">2.774015</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.080775</span><span class="p">,</span> <span class="mf">5.048531</span><span class="p">],</span> <span class="c1"># 54</span>
  <span class="p">[</span><span class="mf">0.000000</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.116408</span><span class="p">,</span> <span class="mf">6.097667</span><span class="p">],</span> <span class="c1"># 57</span>
  <span class="p">[</span><span class="mf">0.000000</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.415691</span><span class="p">,</span> <span class="mf">4.070434</span><span class="p">]</span> <span class="c1"># 8</span>
  <span class="p">])</span>

<span class="n">reproject_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span>
  <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]])</span>

<span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L89</span>
<span class="k">def</span> <span class="nf">decompose</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
  <span class="n">image_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">26</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">39</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">45</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">48</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">54</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">57</span><span class="p">],</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
  <span class="p">])</span>

  <span class="n">_</span><span class="p">,</span> <span class="n">rotation_vec</span><span class="p">,</span> <span class="n">translation_vec</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">solvePnP</span><span class="p">(</span><span class="n">object_pts</span><span class="p">,</span> <span class="n">image_pts</span><span class="p">,</span> <span class="n">cam_matrix</span><span class="p">,</span> <span class="n">dist_coeffs</span><span class="p">)</span>
  <span class="n">reproject_dst</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span><span class="n">reproject_src</span><span class="p">,</span> <span class="n">rotation_vec</span><span class="p">,</span> <span class="n">translation_vec</span><span class="p">,</span> <span class="n">cam_matrix</span><span class="p">,</span> <span class="n">dist_coeffs</span><span class="p">)</span>
  <span class="n">reproject_dst</span> <span class="o">=</span> <span class="n">reproject_dst</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
  <span class="n">rotation_mat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Rodrigues</span><span class="p">(</span><span class="n">rotation_vec</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">reproject_dst</span><span class="p">,</span> <span class="n">rotation_mat</span><span class="p">,</span> <span class="n">rotation_vec</span><span class="p">,</span> <span class="n">translation_vec</span></code></pre></div>
<p>詳しくはOpenCVのsolvePnPとかで調べると良いと思う。</p>

<p>これで回転行列とかが得られるので、顔の回転角度は次で計算する(ちなみにここで得られた行列は「カメラ」基準なことに注意。顔の行列は別に計算が必要)。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L78</span>
<span class="k">def</span> <span class="nf">get_head_pose_angles</span><span class="p">(</span><span class="n">rotation_mat</span><span class="p">,</span> <span class="n">rotation_vec</span><span class="p">,</span> <span class="n">translation_vec</span><span class="p">):</span>
  <span class="n">new_rotation_mat</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rotation_mat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">translation_vec</span><span class="p">)</span>

  <span class="n">rotation_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="n">new_rotation_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">new_rotation_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">rotation_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
  <span class="p">])</span>

  <span class="k">return</span> <span class="n">rotation_vec</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></code></pre></div>
<h4 id="目の開き具合">目の開き具合</h4>

<p>目の開き具合は目の縦幅とかから適当に計算してる(値がハードコードされてるけどカメラ画像のサイズとかに依存するのでアレ 本当はキャリブレーションしないとだめなんだけどそれもしてない)</p>

<p>目は基本的にあまり閉じさせない方がよくて、今のやり方だと半目になることがすごく多いのでこれはどうにかした方がいい。基本はずっと開きっぱなしでたまに閉じるくらいがいいと思うんだけど、どうするのがいいんだろ。瞬きを観測したら瞬きアニメーションを発火とかするとよさそうだけどめんどい</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L102</span>
<span class="k">def</span> <span class="nf">eye_open_param</span><span class="p">(</span><span class="n">eye</span><span class="p">):</span>
  <span class="n">h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">eye</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">eye</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
  <span class="n">h2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">eye</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">eye</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
  <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span> <span class="o">+</span> <span class="n">h2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="mf">0.0</span> <span class="k">if</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mf">3.0</span> <span class="k">else</span>
    <span class="mf">1.0</span> <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mf">8.0</span> <span class="k">else</span>
    <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
  <span class="p">)</span></code></pre></div>
<h4 id="目の中心推定-目線推定">目の中心推定(目線推定)</h4>

<p>目の領域が分かっているので二値化して瞳の中心を推定する。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L113</span>
<span class="k">def</span> <span class="nf">get_center</span><span class="p">(</span><span class="n">gray_img</span><span class="p">):</span>
  <span class="c1"># OpenCV2のmomentsとかいうのを使うと円を推定して中心を計算してくれるらしい</span>
  <span class="n">moments</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">gray_img</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">moments</span><span class="p">[</span><span class="s1">&#39;m10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">moments</span><span class="p">[</span><span class="s1">&#39;m00&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">moments</span><span class="p">[</span><span class="s1">&#39;m01&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">moments</span><span class="p">[</span><span class="s1">&#39;m00&#39;</span><span class="p">])</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">detect_eye_center</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
  <span class="c1"># 右目、左目の領域をアレしておく</span>
  <span class="n">left_eye</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span>
    <span class="nb">min</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">37</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">38</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">41</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">39</span><span class="p">],</span>
  <span class="p">]</span>
  <span class="n">right_eye</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span>
    <span class="nb">min</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">43</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">44</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">46</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">47</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">45</span><span class="p">],</span>
  <span class="p">]</span>

  <span class="k">def</span> <span class="nf">get_eye_center</span><span class="p">(</span><span class="n">eye</span><span class="p">):</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">eye</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">eye</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eye</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># 画像から目の領域を切り出す</span>
    <span class="n">eye</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">eye</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">eye</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># 二値化</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">eye</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">eye</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">)</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">get_center</span><span class="p">(</span><span class="n">eye</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">center</span>
  
  <span class="k">def</span> <span class="nf">normalize_position</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

  <span class="c1"># 中心座標を計算</span>
  <span class="n">left_pos</span> <span class="o">=</span> <span class="n">get_eye_center</span><span class="p">(</span><span class="n">left_eye</span><span class="p">)</span>
  <span class="n">right_pos</span> <span class="o">=</span> <span class="n">get_eye_center</span><span class="p">(</span><span class="n">right_eye</span><span class="p">)</span>

  <span class="c1"># 正規化(0.0から1.0の間の値にmappingする)</span>
  <span class="k">if</span> <span class="n">left_pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">left_normalized_pos</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">left_normalized_pos</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">normalize_position</span><span class="p">(</span>
        <span class="n">left_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nb">min</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">37</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">41</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">38</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">40</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="p">),</span>
      <span class="n">normalize_position</span><span class="p">(</span>
        <span class="n">left_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nb">min</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">37</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">38</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
        <span class="nb">min</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">40</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">41</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
      <span class="p">)</span>
    <span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">left_pos</span><span class="p">,</span> <span class="n">right_pos</span><span class="p">),</span>
    <span class="n">left_normalized_pos</span>
  <span class="p">)</span></code></pre></div>
<h4 id="口の開き具合の推定">口の開き具合の推定</h4>

<p>目と同じように適当にやる(雑)</p>

<h4 id="体の傾き推定">体の傾き推定</h4>

<p>ウィンドウ中心と顔の中心から傾きを適当に推定する。なくてもよいけど若干Live2Dの体の軸で傾斜つけるとそれっぽくなるのでいれてる。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/recognizer.py#L205</span>
<span class="k">def</span> <span class="nf">get_body_pose</span><span class="p">(</span><span class="n">rect</span><span class="p">):</span>
  <span class="c1"># center_of_window = (160,120)</span>
  <span class="n">center_of_face</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">left</span><span class="p">()</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">top</span><span class="p">()</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">90</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="mi">480</span> <span class="o">-</span> <span class="n">center_of_face</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center_of_face</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">360</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span></code></pre></div>
<h3 id="カルマンフィルタ">カルマンフィルタ</h3>

<p>カルマンフィルタを入れると何もかもぬるぬるになる。これがないと結構がくがくになるので入れた方がいい。</p>

<p>カルマンフィルタは前の値と次の値から推定値を出すためのものなので前の値も残しておく必要があることに注意。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># https://github.com/myuon/juniQ/blob/master/server/src/main.py#L19</span>
<span class="k">class</span> <span class="nc">KalmanCache</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># カルマンフィルタの定義</span>
    <span class="c1"># 若干秘伝のたれ入りかも</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">newKalmanFilter</span><span class="p">():</span>
        <span class="n">kalman</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">KalmanFilter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">kalman</span><span class="o">.</span><span class="n">measurementMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">kalman</span><span class="o">.</span><span class="n">transitionMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">kalman</span><span class="o">.</span><span class="n">processNoiseCov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>

        <span class="k">return</span> <span class="n">kalman</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newKalmanFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># 新しい値を突っ込む</span>
    <span class="k">def</span> <span class="nf">correct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">value</span><span class="p">,</span>
            <span class="n">vel</span><span class="p">,</span>
            <span class="n">vel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prevs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vel</span>

    <span class="c1"># 次の値を推定</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></code></pre></div>
<h2 id="viewer-live2dモデル描画">Viewer (live2Dモデル描画)</h2>

<p>Live2Dモデルは事前に作っておきます。</p>

<p>モーションとかをちゃんと設定しておくのと、パーツの描画優先度はきっちり順番にしておくのが大事っぽい。あとパーツは日本語じゃなくてアルファベットの方が都合がいいと思います。</p>

<p>後なんか今のシステムだと物理演算(髪とかの)がちゃんと動いてないっぽいんだけど理由がよくわからない。なんでだろう。</p>
<div class="highlight"><pre class="chroma"><code class="language-ts" data-lang="ts"><span class="c1">// https://github.com/myuon/juniQ/blob/master/viewer/src/viewer.ts#L53
</span><span class="c1"></span>
<span class="kr">class</span> <span class="nx">App</span> <span class="p">{</span>
    <span class="nx">app</span>: <span class="kt">PIXI.Application</span><span class="p">;</span>
    <span class="nx">model</span>: <span class="kt">LIVE2DCUBISMPIXI.Model</span><span class="p">;</span>
    <span class="nx">position</span><span class="o">:</span> <span class="p">[</span><span class="kt">number</span><span class="p">,</span> <span class="kt">number</span><span class="p">];</span>
    <span class="nx">scaler</span><span class="o">:</span> <span class="p">[</span><span class="kt">number</span><span class="p">,</span> <span class="kt">number</span><span class="p">];</span>
    <span class="nx">size</span><span class="o">:</span> <span class="p">[</span><span class="kt">number</span><span class="p">,</span> <span class="kt">number</span><span class="p">];</span>
    <span class="nx">empty_animation</span>: <span class="kt">LIVE2DCUBISMFRAMEWORK.Animation</span><span class="p">;</span>

    <span class="p">...</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
    <span class="nx">size</span><span class="o">:</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">720</span><span class="p">],</span>
    <span class="nx">moc</span><span class="o">:</span> <span class="s2">&#34;assets/yugure_neko_avatar/yugure_neko_export.moc3&#34;</span><span class="p">,</span>
    <span class="nx">texture</span><span class="o">:</span> <span class="s2">&#34;assets/yugure_neko_avatar/yugure_neko_export.2048/texture_00.png&#34;</span><span class="p">,</span>
    <span class="nx">physics</span><span class="o">:</span> <span class="s2">&#34;assets/yugure_neko_avatar/yugure_neko_export.physics3.json&#34;</span><span class="p">,</span>
    <span class="nx">empty_motion</span><span class="o">:</span> <span class="s2">&#34;assets/empty_motion.json&#34;</span><span class="p">,</span>
    <span class="nx">position</span><span class="o">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">720</span><span class="p">],</span>
    <span class="nx">scaler</span><span class="o">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
<span class="p">});</span></code></pre></div>
<p>アプリケーション本体はAppクラスで記述します。モデルの読み込みとか設定とかをします。</p>

<p>パスはハードコードなんやすまんなという気持ち(気持ちのみ)。</p>

<p>以下はconstructorの中身です。(この辺はSDK for webのexampleとか見たら大体分かると思う)</p>
<div class="highlight"><pre class="chroma"><code class="language-ts" data-lang="ts"><span class="c1">// https://github.com/myuon/juniQ/blob/master/viewer/src/viewer.ts#L72
</span><span class="c1"></span>                <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PIXI</span><span class="p">.</span><span class="nx">Application</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span> <span class="nx">backgroundColor</span>: <span class="kt">0x00ff00</span> <span class="p">});</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">);</span>

                <span class="kd">let</span> <span class="nx">moc</span> <span class="o">=</span> <span class="nx">LIVE2DCUBISMCORE</span><span class="p">.</span><span class="nx">Moc</span><span class="p">.</span><span class="nx">fromArrayBuffer</span><span class="p">(</span><span class="nx">resources</span><span class="p">[</span><span class="s1">&#39;moc&#39;</span><span class="p">].</span><span class="nx">data</span><span class="p">);</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LIVE2DCUBISMPIXI</span><span class="p">.</span><span class="nx">ModelBuilder</span><span class="p">()</span>
                    <span class="p">.</span><span class="nx">setMoc</span><span class="p">(</span><span class="nx">moc</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">setTimeScale</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1">// テクスチャ
</span><span class="c1"></span>                    <span class="p">.</span><span class="nx">addTexture</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">resources</span><span class="p">[</span><span class="s1">&#39;texture&#39;</span><span class="p">].</span><span class="nx">texture</span><span class="p">)</span>
                    <span class="c1">// 物理演算の設定
</span><span class="c1"></span>                    <span class="p">.</span><span class="nx">setPhysics3Json</span><span class="p">(</span><span class="nx">resources</span><span class="p">[</span><span class="s1">&#39;physics&#39;</span><span class="p">].</span><span class="nx">data</span><span class="p">)</span>
                    <span class="c1">// これはなんで要るんだっけ…(ﾄｵｲﾒ)
</span><span class="c1"></span>                    <span class="p">.</span><span class="nx">addAnimatorLayer</span><span class="p">(</span><span class="s2">&#34;base&#34;</span><span class="p">,</span> <span class="nx">LIVE2DCUBISMFRAMEWORK</span><span class="p">.</span><span class="nx">BuiltinAnimationBlenders</span><span class="p">.</span><span class="nx">OVERRIDE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">processModel</span><span class="p">();</span> <span class="c1">// モデルをちょっといじる(後述)
</span><span class="c1"></span>
                <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">addChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">addChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">masks</span><span class="p">);</span>

                <span class="c1">// この辺でアニメーションレイヤーの初期化を行います。
</span><span class="c1"></span>                <span class="c1">// アニメーションは実際にパラメータを投げられたら設定して動かすみたいになるので
</span><span class="c1"></span>                <span class="c1">// ここでは空にしておきます
</span><span class="c1"></span>                <span class="k">this</span><span class="p">.</span><span class="nx">empty_animation</span> <span class="o">=</span> <span class="nx">LIVE2DCUBISMFRAMEWORK</span><span class="p">.</span><span class="nx">Animation</span><span class="p">.</span><span class="nx">fromMotion3Json</span><span class="p">(</span><span class="nx">resources</span><span class="p">[</span><span class="s1">&#39;empty_motion&#39;</span><span class="p">].</span><span class="nx">data</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">empty_animation</span><span class="p">.</span><span class="nx">evaluate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">time</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">weight</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">blend</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">target</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="p">};</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">animator</span><span class="p">.</span><span class="nx">getLayer</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">).</span><span class="nx">play</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">empty_animation</span><span class="p">);</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">add</span><span class="p">((</span><span class="nx">deltaTime</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">masks</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">renderer</span><span class="p">);</span>
                <span class="p">});</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">setStageTransform</span><span class="p">();</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">onResize</span><span class="p">();</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">sendToParent</span><span class="p">();</span></code></pre></div>
<p><code>processModel</code>というのがマスクとモデルレイヤーの処理を行います。これをしとかないとうまく画面に表示されない(表示順とか表示領域がおかしくなるっぽい)</p>
<div class="highlight"><pre class="chroma"><code class="language-ts" data-lang="ts"><span class="c1">// https://github.com/myuon/juniQ/blob/master/viewer/src/viewer.ts#L126
</span><span class="c1"></span>    <span class="nx">processModel</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// レイヤーを表示順に沿って並べ替える
</span><span class="c1"></span>        <span class="c1">// 勝手には並べてくれないのでこれをしないと表示順が変になる
</span><span class="c1"></span>        <span class="kd">let</span> <span class="nx">orders</span><span class="o">:</span> <span class="p">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">number</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">k</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">drawables</span><span class="p">.</span><span class="nx">ids</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">orders</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">drawables</span><span class="p">.</span><span class="nx">ids</span><span class="p">[</span><span class="nx">k</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">drawables</span><span class="p">.</span><span class="nx">renderOrders</span><span class="p">[</span><span class="nx">k</span><span class="p">]]);</span>
        <span class="p">}</span>
        <span class="nx">orders</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">x</span><span class="o">:</span><span class="p">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">number</span><span class="p">],</span> <span class="nx">y</span><span class="o">:</span> <span class="p">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">number</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="c1">// メッシュを新たに追加みたいなことをする
</span><span class="c1"></span>        <span class="c1">// ここは完全に謎だけどこれをしないと目の表示とか上手くいかなかった
</span><span class="c1"></span>        <span class="c1">// 謎が深い
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">removeChildren</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">mesh_name</span><span class="p">,</span> <span class="nx">_</span><span class="p">]</span> <span class="nx">of</span> <span class="nx">orders</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">mesh</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getModelMeshById</span><span class="p">(</span><span class="nx">mesh_name</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">addChild</span><span class="p">(</span><span class="nx">mesh</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span></code></pre></div>
<p>実際にアニメーションとかをするのは次の処理。<code>animateByParams</code>を呼ぶとアニメーションが始まる。これを1秒に何回も呼ぶことで滑らかなアニメーションになるけど、一方でめっちゃ重くなる(当たり前や)のでもっと工夫した方がいい説ある。</p>
<div class="highlight"><pre class="chroma"><code class="language-ts" data-lang="ts"><span class="c1">// https://github.com/myuon/juniQ/blob/master/viewer/src/viewer.ts#L173
</span><span class="c1"></span>    <span class="nx">animateByParams</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="o">:</span> <span class="p">{[</span><span class="nx">key</span>:<span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kt">string</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">empty_animation</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">empty_animation</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="c1">// さっき初期化しておいたempty_animationを使う
</span><span class="c1"></span>        <span class="c1">// evaluateに関数をセットしてplayすると動く
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">empty_animation</span><span class="p">.</span><span class="nx">evaluate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">time</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">weight</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">blend</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">target</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">// ここではparamsに動かしたいパラメータが入ってる
</span><span class="c1"></span>            <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">parameter_name</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">ids</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                <span class="c1">// アニメーションはblendを使っていい感じの値を作ることで実現する
</span><span class="c1"></span>                <span class="c1">// まぁ適当でもなんとかなってる(ほんまか？)
</span><span class="c1"></span>                <span class="nx">target</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">parameter_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">blend</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">parameter_name</span><span class="p">],</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">weight</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">animator</span><span class="p">.</span><span class="nx">getLayer</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">).</span><span class="nx">play</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">empty_animation</span><span class="p">);</span>
    <span class="p">};</span></code></pre></div>
<p>後はまぁマウスホイールやクリックでモデルを拡大縮小したり動かしたりスライダーでパラメータ設定したりする機能があるけどどうでもいいので飛ばす。</p>

<h2 id="このシステムについて">このシステムについて</h2>

<p>色々と問題があり値がハードコードされてたりソースコードがめっちゃ汚かったりdockerの使い方おかしかったり(ていうかビルドの仕組みちゃんとアレしたい)キャリブレーションがなかったりするので使うときはその辺をどうにかした方がいいと思います。</p>

<p>まぁでも一応動いていてそれっぽくはなるので遊びたい人はどうぞ。</p>

<p>あと結構重いのでずっと動かしっぱにするとCPUなどによくない可能性がある。軽量化もしたいんだけどなー。</p>

<p>Unityで作り直そうとずっと思っているんですがネイティブプラグインの作り方とかそれがどれくらいしんどいことなのかとかが皆目見当もつかないので悩んでるという感じです。</p>

<p>まーとにかく、Live2D SDKもOpenCVもdlibも使うの初めてで顔検出とかさっぱりわからぬという状態だったんだけどとりあえず動くものができたのはよかったかなと思います。</p>

<h2 id="最後に">最後に</h2>

<p>夕暮寝子ちゃんをよろしくお願いします(って言ってもなんもコンテンツがないんだけど)</p>

<p>あと公開に対して許可をくれたLive2Dの方ありがとうございました。</p>
</section>
    <footer>
      <hr>
      <div class="meta">
        <p class="categories"></p>
        <p class="tags">
          
        </p>
      </div>
      <hr>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "the-curse-of-lambda" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer>
  </article>

    </main>
    <footer>
  <p>
    &copy; 2019 myuon.
  </p>
  <p>
    Powered by <a href="https://gohugo.io" title="A Fast and Flexible Website Generator">Hugo</a> &amp; <a href="https://github.com/eshlox/simplicity" title="Hugo theme">Simplicity</a>.
  </p>
</footer>

    <script src="/assets/js/main.82829af440c4.js"></script>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-33072399-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
